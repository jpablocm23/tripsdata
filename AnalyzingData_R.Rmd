---
title: "Analyzing Data with R"
author: "Juan Pablo Contreras M"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Case Study: Bike-sharing company

## How Does a Bike-Share Navigate Speedy Success?

### Introduction

This is an example of the work I can do with R programming language using a case study example.

### Scenario

You are a junior data analyst working in the marketing analyst team at Cyclistic, a bike-share company in Chicago. The director of marketing believes the company's future success depends on maximizing the number of annual memberships. Therefore, your team wants to understand how casual riders and annual members use Cyclistic bikes differently. From these insights, your team will design a new marketing strategy to convert casual riders into annual members. But first, Cyclistic executives must approve your recommendations, so they must be backed up with compelling data insights and professional data visualizations.

### Characters and teams

● **Cyclistic:** A bike-share program that features more than 5,800 bicycles and 600 docking stations. Cyclistic sets itself apart by also offering reclining bikes, hand tricycles, and cargo bikes, making bike-share more inclusive to people with disabilities and riders who can't use a standard two-wheeled bike. The majority of riders opt for traditional bikes; about 8% of riders use the assistive options. Cyclistic users are more likely to ride for leisure, but about 30% use them to commute to work each day.

● **Lily Moreno:** The director of marketing and your manager. Moreno is responsible for the development of campaigns and initiatives to promote the bike-share program. These may include email, social media, and other channels.

● **Cyclistic marketing analytics team:** A team of data analysts who are responsible for collecting, analyzing, and reporting data that helps guide Cyclistic marketing strategy. You joined this team six months ago and have been busy learning about Cyclistic's mission and business goals --- as well as how you, as a junior data analyst, can help Cyclistic achieve them.

● **Cyclistic executive team:** The notoriously detail-oriented executive team will decide whether to approve the recommended marketing program

### About the company

In 2016, Cyclistic launched a successful bike-share offering. Since then, the program has grown to a fleet of 5,824 bicycles that are geotracked and locked into a network of 692 stations across Chicago. The bikes can be unlocked from one station and returned to any other station in the system anytime.

Until now, Cyclistic's marketing strategy relied on building general awareness and appealing to broad consumer segments. One approach that helped make these things possible was the flexibility of its pricing plans: single-ride passes, full-day passes, and annual memberships. Customers who purchase single-ride or full-day passes are referred to as casual riders. Customers who purchase annual memberships are Cyclistic members.

Cyclistic's finance analysts have concluded that annual members are much more profitable than casual riders. Although the pricing flexibility helps Cyclistic attract more customers, Moreno believes that maximizing the number of annual members will be key to future growth. Rather than creating a marketing campaign that targets all-new customers, Moreno believes there is a very good chance to convert casual riders into members. She notes that casual riders are already aware of the Cyclistic program and have chosen Cyclistic for their mobility needs.

Moreno has set a clear goal: Design marketing strategies aimed at converting casual riders into annual members. In order to do that, however, the marketing analyst team needs to better understand how annual members and casual riders differ, why casual riders would buy a membership, and how digital media could affect their marketing tactics. Moreno and her team are interested in analyzing the Cyclistic historical bike trip data to identify trends.

## Step 1: Collect Data

This analysis is based on the Divvy case study "'Sophisticated, Clear, and Polished': Divvy and Data Visualization" written by Kevin Hartman (found here: <https://artscience.blog/home/divvy-dataviz-case-study>).

The purpose of this script is to conduct simple analysis to help answer the key question: **"In what ways do members and casual riders use Divvy bikes differently?"**

Firs we need to install the required packages:

-   tidyverse for data import and wrangling
-   lubridate for date functions
-   ggplot for visualization

```{r}
library(tidyverse)  #helps wrangle data
library(lubridate)  #helps wrangle date attributes
library(ggplot2)  #helps visualize data
library(dplyr)

```

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAYAAADFTB7LAAAAa0lEQVR42u3OywnAIBBAwcXSUoCW5D11xDoNCBGNv0MOecJOBSOi1OZMsJ4dvFxEJ1OQnMxBarIKEpNNkJbsBknJYZCSnAYJyVVQziNig7/nZkFEbhTE5HpBVO4dxOXKIDL3BLG5BJ1T6rsbMfep2CaMN00AAAAASUVORK5CYII= "Run Current Chunk")

Then we need to check the directory where we are working

```{r}
getwd() #displays your working directory
setwd("C:/Users/jpcmi/OneDrive/Documents/Curso Data Analytics by Google/Course8_Capstone/CaseStudyData/R files")

```

Collecting the data from source. In this case we are importing data from March and April 2021:

```{r}
marchdata <- read.csv("202103-divvy-tripdata.csv")
aprildata <- read.csv("202104-divvy-tripdata.csv")
 
```

## Step 2: Wrangle Data and Combine into a single file

When we want to join two tables we need to check for column names.While the names don't have to be in the same order, they DO need to match perfectly before we can use a command to join them into one file:

```{r}
colnames(aprildata)
colnames(marchdata)
```

As we can see, the column names are equals so we proceed to inspect the dataframe and look for incongruencies:

```{r}
str(marchdata)
str(aprildata)

```

Finally we stack individual data frames into one big data frame:

```{r}
all_trips <- rbind(marchdata, aprildata)

```

Once we have the joined table, we review which are the variables that will not be used in the analysis, and we proceed to remove them:

```{r}
all_trips <- all_trips %>% 
  select(-c(start_lat,start_lng,end_lat,end_lng))
```

## Step 3: Clean up and Add Data to prepare for Analysis

In this step first we inspect the new table that has been created:

```{r}
colnames(all_trips)  #List of column names
nrow(all_trips)  #How many rows are in data frame?
dim(all_trips)  #Dimensions of the data frame?
head(all_trips)  #See the first 6 rows of data frame.  Also tail(all_trips)
str(all_trips)  #See list of columns and data types (numeric, character, etc)
summary(all_trips)  #Statistical summary of data. Mainly for numerics
```

There are a few problems we will need to fix:

-   The data can only be aggregated at the ride-level, which is too granular. We will want to add some additional columns of data -- such as **day**, **month**, **year** -- that provide additional opportunities to aggregate the data.
-   We will want to add a calculated field for length of ride since the 2020Q1 data did not have the "tripduration" column. We will add **"ride_length"** to the entire dataframe for consistency.
-   There are some rides where tripduration shows up as negative, including several hundred rides where Divvy took bikes out of circulation for Quality Control reasons. We will want to delete these rides.

```{r}
# Add columns that list the date, month, day, and year of each ride

all_trips$date <- as.Date(all_trips$started_at) #The default format is yyyy-mm-dd
all_trips$month <- format(as.Date(all_trips$date), "%m")
all_trips$day <- format(as.Date(all_trips$date), "%d")
all_trips$year <- format(as.Date(all_trips$date), "%Y")
all_trips$day_of_week <- format(as.Date(all_trips$date), "%A")

# Add a "ride_length" calculation to all_trips (in seconds)

all_trips$ride_length <- difftime(all_trips$ended_at,all_trips$started_at)

```

Once we create the variables, we inspect the structure of the columns:

```{r}
str(all_trips)
summary(all_trips)  #Statistical summary of data. Mainly for numerics
```

The type of our new variable **ride_length** is not numeric, so wee need to convert it to numeric so we can run calculations on the data:

```{r}
is.factor(all_trips$ride_length) #checking...
typeof(all_trips$ride_length)

all_trips$ride_length <- as.numeric(as.character(all_trips$ride_length)) # defining the type of the variable

is.numeric(all_trips$ride_length)
summary(all_trips)  #Statistical summary of data. Mainly for numerics
typeof(all_trips$ride_length)  #cheking
```

The dataframe includes a few hundred entries when bikes were taken out of docks and checked for quality by Divvy or ride_length was negative:

```{r}
all_trips_V2 <- all_trips[!(all_trips$start_station_name == "HQ QR" | all_trips$ride_length<0),]

```

## Step 4: Conduct Descriptive Analysis

```{r}
mean(all_trips_V2$ride_length) #straight average (total ride length / rides)
median(all_trips_V2$ride_length) #midpoint number in the ascending array of ride lengths
max(all_trips_V2$ride_length) #longest ride
min(all_trips_V2$ride_length) #shortest ride

# You can condense the four lines above to one line using summary() on the specific attribute
summary(all_trips_V2$ride_length)

```

After the summary of our analysis, we start to compare the different *type of users*:

```{r}
aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual, FUN = mean)
aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual, FUN = median)
aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual, FUN = max)
aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual, FUN = min)

```

See the average ride time by each day for members vs casual users:

```{r}
# Notice that the days of the week are out of order. Let's fix that.

aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual + all_trips_V2$day_of_week, FUN = mean)

```

Now, let's run the average ride time by each day for members vs casual users:

```{r}
aggregate(all_trips_V2$ride_length ~ all_trips_V2$member_casual + all_trips_V2$day_of_week, FUN = mean)

```

Analyzing ridership data by type and weekday, ordered by user type and number of rides (desc):

```{r}
all_trips_V2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>%  #creates weekday field using wday()
  group_by(member_casual, weekday) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n()							#calculates the number of rides and average duration 
            ,average_duration = mean(ride_length)) %>% 		# calculates the average duration
  arrange(member_casual, -number_of_rides)
```

Now that we have the table with the information, we can visualize the number of rides, by the next variables:

```{r}
all_trips_V2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") + labs(title="Number of Rides by User Type")
```

\

```{r}
all_trips_V2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge") + labs(title="Average Ride Duration by User Type")
```
